'use strict';
/**
* all music information
*/

var musicData = [
	{
		posterUrl: "./assets/images/renso.png",
		title: "Ancorati al cielo",
		album: "bans",
		year: 2013,
		artist: "",
		musicPath: "./assets/music/bans/Ancorati al cielo.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Che bello",
		album: "bans",
		year: 2013,
		artist: "",
		musicPath: "./assets/music/bans/Che bello.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Chocolate",
		album: "bans",
		year: 2021,
		artist: "",
		musicPath: "./assets/music/bans/Chocolate.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Da Mi Animas",
		album: "bans",
		year: 2013,
		artist: "",
		musicPath: "./assets/music/bans/Da Mi Animas.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Danza Kuduro",
		album: "bans",
		year: 2010,
		artist: "",
		musicPath: "./assets/music/bans/Danza Kuduro.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "El Simbolo",
		album: "bans",
		year: 2014,
		artist: "",
		musicPath: "./assets/music/bans/El Simbolo.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Fiesta Celestial",
		album: "bans",
		year: 2012,
		artist: "",
		musicPath: "./assets/music/bans/Fiesta Celestial.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Fuori di tenda",
		album: "bans",
		year: 2011,
		artist: "",
		musicPath: "./assets/music/bans/Fuori di tenda.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Galopea",
		album: "bans",
		year: 2024,
		artist: "",
		musicPath: "./assets/music/bans/Galopea.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Geronimo",
		album: "bans",
		year: 2011,
		artist: "",
		musicPath: "./assets/music/bans/Geronimo.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Grande Chef",
		album: "bans",
		year: 2011,
		artist: "",
		musicPath: "./assets/music/bans/Grande Chef.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "I russi",
		album: "intrattenimento",
		year: 2012,
		artist: "",
		musicPath: "./assets/music/bans/Russi.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Il ballo di Alvin",
		album: "bans",
		year: 2016,
		artist: "",
		musicPath: "./assets/music/bans/Il ballo di Alvin.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Jumpin Up",
		album: "bans",
		year: 2018,
		artist: "",
		musicPath: "./assets/music/bans/Jumpin Up.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Just jungle",
		album: "bans",
		year: 2024,
		artist: "",
		musicPath: "./assets/music/bans/JUST JUNGLE.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Kokou Move",
		album: "bans",
		year: 2025,
		artist: "",
		musicPath: "./assets/music/bans/Kokou Move.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Le nubi di Anubi",
		album: "bans",
		year: 2013,
		artist: "",
		musicPath: "./assets/music/bans/le nubi di anubi.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Limbo",
		album: "bans",
		year: 2022,
		artist: "",
		musicPath: "./assets/music/bans/Limbo.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Love",
		album: "bans",
		year: 2019,
		artist: "",
		musicPath: "./assets/music/bans/LOVE.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Moto Moto",
		album: "bans",
		year: 2020,
		artist: "",
		musicPath: "./assets/music/bans/moto moto.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Pokémon",
		album: "bans",
		year: 2017,
		artist: "",
		musicPath: "./assets/music/bans/POKEMON.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Replug & Play",
		album: "bans",
		year: 2018,
		artist: "",
		musicPath: "./assets/music/bans/Replug e Play.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Ritmo Vuelta",
		album: "bans",
		year: 2023,
		artist: "",
		musicPath: "./assets/music/bans/RITMO VUELTA.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Salta!",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/bans/Salta.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Segno nel sogno",
		album: "bans",
		year: 2012,
		artist: "",
		musicPath: "./assets/music/bans/Segno nel Sogno.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Smack",
		album: "bans",
		year: 2013,
		artist: "",
		musicPath: "./assets/music/bans/Smack.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Soco Bate Vira",
		album: "intrattenimento",
		year: 2011,
		artist: "",
		musicPath: "./assets/music/bans/Soco Bate Vira.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Sofia",
		album: "bans",
		year: 2016,
		artist: "",
		musicPath: "./assets/music/bans/Sofia.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "W LO SPORT",
		album: "bans",
		year: 2016,
		artist: "",
		musicPath: "./assets/music/bans/W LO SPORT.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Waka Waka",
		album: "bans",
		year: 2010,
		artist: "",
		musicPath: "./assets/music/bans/Waka Waka.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Wunder",
		album: "bans",
		year: 2019,
		artist: "",
		musicPath: "./assets/music/bans/Wunder.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "DIVISORIO",
		album: "bans",
		year: 2019,
		artist: "",
		musicPath: "./assets/music/bans/DIVISORIO.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Baila como el papu",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/Baila Como El Papu.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Bicicletta",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/bicicletta.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Chu chu ua",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/Chu chu ua.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Cotton Eye Joe",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/Cotton Eye Joe.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Gioca Jouer",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/Gioca Jouer.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "La bomba",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/La Bomba.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "La canzone del capitano uncino",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/La Canzone Del Capitano Uncino.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "La Macarena",
		album: "intrattenimento",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/La Macarena.mp3",
	},
	{
		posterUrl: "./assets/images/renso.png",
		title: "Mueve la colita",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/Mueve La Colita.mp3",
	},
	{
		posterUrl: "",
		title: "YMCA",
		album: "bans",
		year: "???",
		artist: "",
		musicPath: "./assets/music/intrattenimento/YMCA.mp3",
	}
];

/**
 * random cat image
 */

async function randomCat() {
	try {
		const response = await fetch("https://api.thecatapi.com/v1/images/search");
		const data = await response.json();
		return data[0].url; // restituisce solo l’URL
	} catch (error) {
		console.error("Errore nel caricamento dell'immagine del gatto:", error);
		return "./assets/images/renso.png"; // fallback
	}
}


// Mostra un gatto all'avvio
window.onload = randomCat;



function getSongsArray(){
	return musicData;
}

/**
 * add eventListnere on all elements that are passed
 */

const addEventOnElements = function (elements, eventType, callback) {
	for (let i = 0, len = elements.length; i < len; i++) {
		elements[i].addEventListener(eventType, callback);
	}
}
/**
 * PLAYLIST
 * 
 * add all music in playlist, from 'musicData'
 */
const playlist = document.querySelector("[data-music-list]");

for (let i = 0, len = musicData.length; i < len; i++) {
	playlist.innerHTML += `
	<li>
		<button class="music-item ${i === 0 ? "playing" : ""}" data-playlist-toggler data-playlist-item="${i}">
			<div class="list-item">
				<p>${musicData[i].title}</p>
			</div>
			<div class="item-icon">
				<span class="material-symbols-rounded">equalizer</span>
			</div>
		</button>
	</li>
	`;
}
/**
 * PLAYLIST MODAL SIDEBAR TOGGLE
 * 
 * show 'playlist' modal sidebar when click on playlist button in top app bar
 * and hide when click on overlay or any playlist-item
 */

const playlistSideModal = document.querySelector("[data-playlist]");
const playlistTogglers = document.querySelectorAll("[data-playlist-toggler]");
const overlay = document.querySelector("[data-overlay]");

const togglePlaylist = function () {
	playlistSideModal.classList.toggle("active");
	overlay.classList.toggle("active");
	document.body.classList.toggle("modalActive");
}

addEventOnElements(playlistTogglers, "click", togglePlaylist);

/**
 * PLAYLIST ITEM
 * 
 * remove active state from last time played music
 * and add active state in clicked music
 */

const playlistItems = document.querySelectorAll("[data-playlist-item]");

let currentMusic = 0;
let lastPlayedMusic = 0;

const changePlaylistItem = function () {
	playlistItems[lastPlayedMusic].classList.remove("playing");
	playlistItems[currentMusic].classList.add("playing");
}

addEventOnElements(playlistItems, "click", function () {
	lastPlayedMusic = currentMusic;
	currentMusic = Number(this.dataset.playlistItem);
	changePlaylistItem();
});

/**
 * PLAYER
 * 
 * change all visual information on player, based on current music
 */

const playerBanner = document.querySelector("[data-player-banner]");
const playerTitle = document.querySelector("[data-title]");
const playerAlbum = document.querySelector("[data-album]");
const playerYear = document.querySelector("[data-year]");
const playerArtist = document.querySelector("[data-artist]");

const audioSource = new Audio(musicData[currentMusic].musicPath);

const changePlayerInfo = async function () {
	const imgUrl = await randomCat();
	playerBanner.src = imgUrl;
	playerBanner.setAttribute("alt", `${musicData[currentMusic].title} Album Poster`);
	document.body.style.backgroundImage = `url(${musicData[currentMusic].posterUrl})`;
	playerTitle.textContent = musicData[currentMusic].title;
	playerAlbum.textContent = musicData[currentMusic].album;
	playerYear.textContent = musicData[currentMusic].year;
	playerArtist.textContent = musicData[currentMusic].artist;

	audioSource.src = musicData[currentMusic].musicPath;

	audioSource.addEventListener("loadeddata", updateDuration);
	playMusic();
}

addEventOnElements(playlistItems, "click", changePlayerInfo);

/** update player duration */
const playerDuration = document.querySelector("[data-duration]");
const playerSeekRange = document.querySelector("[data-seek]");

/** pass seconds and get timcode formate */
const getTimecode = function (duration) {
	const minutes = Math.floor(duration / 60);
	const seconds = Math.ceil(duration - (minutes * 60));
	const timecode = `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
	return timecode;
}

const updateDuration = function () {
	playerSeekRange.max = Math.ceil(audioSource.duration);
	playerDuration.textContent = getTimecode(Number(playerSeekRange.max));
}

audioSource.addEventListener("loadeddata", updateDuration);

/**
 * PLAY MUSIC
 * 
 * play and pause music when click on play button
 */

const playBtn = document.querySelector("[data-play-btn]");

let playInterval;

const playMusic = function () {
	if (audioSource.paused) {
		audioSource.play();
		playBtn.classList.add("active");
		playInterval = setInterval(updateRunningTime, 500);
	} else {
		audioSource.pause();
		playBtn.classList.remove("active");
		clearInterval(playInterval);
	}
}

playBtn.addEventListener("click", playMusic);

/** update running time while playing music */

const playerRunningTime = document.querySelector("[data-running-time]");

const updateRunningTime = function () {
	playerSeekRange.value = audioSource.currentTime;
	playerRunningTime.textContent = getTimecode(audioSource.currentTime);

	updateRangeFill();
	isMusicEnd();
}

/**
 * RANGE FILL WIDTH
 * 
 * change 'rangeFill' width, while changing range value
 */

const ranges = document.querySelectorAll("[data-range]");
const rangeFill = document.querySelector("[data-range-fill]");

const updateRangeFill = function () {
	let element = this || ranges[0];

	const rangeValue = (element.value / element.max) * 100;
	element.nextElementSibling.style.width = `${rangeValue}%`;
}

addEventOnElements(ranges, "input", updateRangeFill);

/**
 * SEEK MUSIC
 * 
 * seek music while changing player seek range
 */

const seek = function () {
	audioSource.currentTime = playerSeekRange.value;
	playerRunningTime.textContent = getTimecode(playerSeekRange.value);
}

playerSeekRange.addEventListener("input", seek);

/**
 * END MUSIC
 */

const isMusicEnd = function () {
	if (audioSource.ended) {
		playBtn.classList.remove("active");
		audioSource.currentTime = 0;
		playerSeekRange.value = audioSource.currentTime;
		playerRunningTime.textContent = getTimecode(audioSource.currentTime);
		updateRangeFill();
	}
}

/**
 * SKIP TO NEXT MUSIC
 */

const playerSkipNextBtn = document.querySelector("[data-skip-next]");

const skipNext = function () {
	lastPlayedMusic = currentMusic;

	if (isShuffled) {
		shuffleMusic();
	} else {
		currentMusic >= musicData.length - 1 ? currentMusic = 0 : currentMusic++;
	}

	changePlayerInfo();
	changePlaylistItem();
}

playerSkipNextBtn.addEventListener("click", skipNext);

/**
 * SKIP TO PREVIOUS MUSIC
 */

const playerSkipPrevBtn = document.querySelector("[data-skip-prev]");

const skipPrev = function () {
	lastPlayedMusic = currentMusic;

	if (isShuffled) {
		shuffleMusic();
	} else {
		currentMusic <= 0 ? currentMusic = musicData.length - 1 : currentMusic--;
	}

	changePlayerInfo();
	changePlaylistItem();
}

playerSkipPrevBtn.addEventListener("click", skipPrev);

/**
 * SHUFFLE MUSIC
 */

/** get random number for shuffle */
const getRandomMusic = () => Math.floor(Math.random() * musicData.length);

const shuffleMusic = () => currentMusic = getRandomMusic();

const playerShuffleBtn = document.querySelector("[data-shuffle]");
let isShuffled = false;

const shuffle = function () {
	playerShuffleBtn.classList.toggle("active");

	isShuffled = isShuffled ? false : true;
}

playerShuffleBtn.addEventListener("click", shuffle);

/**
 * REPEAT MUSIC
 */

const playerRepeatBtn = document.querySelector("[data-repeat]");

const repeat = function () {
	if (!audioSource.loop) {
		audioSource.loop = true;
		this.classList.add("active");
	} else {
		audioSource.loop = false;
		this.classList.remove("active");
	}
}

playerRepeatBtn.addEventListener("click", repeat);

/**
* MUSIC VOLUME
* 
* increase or decrease music volume when change the volume range
*/

const playerVolumeRange = document.querySelector("[data-volume]");
const playerVolumeBtn = document.querySelector("[data-volume-btn]");

const changeVolume = function () {
	audioSource.volume = playerVolumeRange.value;
	audioSource.muted = false;

	if (audioSource.volume <= 0.1) {
		playerVolumeBtn.children[0].textContent = "volume_mute";
	} else if (audioSource.volume <= 0.5) {
		playerVolumeBtn.children[0].textContent = "volume_down";
	} else {
		playerVolumeBtn.children[0].textContent = "volume_up";
	}
}

playerVolumeRange.addEventListener("input", changeVolume);

/**
 * MUTE MUSIC
 */

const muteVolume = function () {
	if (!audioSource.muted) {
		audioSource.muted = true;
		playerVolumeBtn.children[0].textContent = "volume_off";
	} else {
		changeVolume();
	}
}

playerVolumeBtn.addEventListener("click", muteVolume);
